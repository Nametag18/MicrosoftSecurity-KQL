let DeviceTypes = (DeviceInfo
| where Timestamp >= ago(30d)
| where isnotempty(DeviceType)
| summarize arg_max(Timestamp, *) by DeviceName
| project DeviceName, DeviceType);
let UserDevices = (DeviceInfo
| where Timestamp >= ago(30d)
| where LoggedOnUsers != "[]"
| summarize arg_max(Timestamp, *) by DeviceName
| extend LastUser = tostring(parse_json(LoggedOnUsers).[0]["UserName"])
| extend UserDomain = tostring(parse_json(LoggedOnUsers).[0].["DomainName"])
| project DeviceName, LastUser, UserDomain);
let VulnDevices = (DeviceTvmSoftwareVulnerabilities
| project SoftwareName, SoftwareVendor, CveId, DeviceName
| join kind = leftouter (DeviceTvmSoftwareVulnerabilitiesKB | project CvssScore, CveId, PublishedDate) on CveId
| where CvssScore >= 7
//| summarize ["CVE's above CVSS 7.0"]=dcountif(CveId, CvssScore > 7.0), ["Total CVE's"]=dcount(CveId), ["Average CVSS Score"]=round(avg(CvssScore),1), ["Sum CVSSS Score"]=round(sum(CvssScore)) by DeviceName
| join kind = leftouter UserDevices on DeviceName
| join kind = leftouter DeviceTypes on DeviceName
| summarize ["Vulnerable Device Count"]=dcount(DeviceName), ["Vulnerable Device List"]=make_set(DeviceName), ["Logged In Users"]=make_set(LastUser), count() by SoftwareName, SoftwareVendor);
let DeviceCount = (DeviceTvmSoftwareVulnerabilities
| project SoftwareName, SoftwareVendor, CveId, DeviceName
| join kind = leftouter (DeviceTvmSoftwareVulnerabilitiesKB | project CvssScore, CveId, PublishedDate) on CveId
| where CvssScore >= 7
| summarize ["Devices with 7+ CVSS"]=dcount(DeviceName) by SoftwareVendor, SoftwareName);
DeviceTvmSoftwareVulnerabilities
| distinct SoftwareName, SoftwareVendor, CveId
| join kind = leftouter (DeviceTvmSoftwareVulnerabilitiesKB | project CvssScore, CveId, PublishedDate) on CveId
| project-away CveId1
| where CvssScore >= 7
| summarize ["Highest CVSS Score"]=max(CvssScore), ["Lowest CVSS Score"]=min(CvssScore), ["CVE Count"]=dcount(CveId), ["Oldest CVSS Date"]=min(PublishedDate) by SoftwareVendor, SoftwareName
| join DeviceCount on SoftwareName, SoftwareVendor
| project-away SoftwareName1, SoftwareVendor1
| sort by ['Devices with 7+ CVSS']
| join kind = leftouter (VulnDevices | project SoftwareName, ["Vulnerable Device List"], ["Logged In Users"])  on SoftwareName
| project-away SoftwareName1